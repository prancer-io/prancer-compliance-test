package rule

array_contains(target_array, element) = true {
  lower(target_array[_]) == lower(element)
} else = false { true }

# https://docs.microsoft.com/en-us/azure/templates/microsoft.sql/servers/vulnerabilityassessments?tabs=json

#
# PR-AZR-CLD-SQL-051
#

default sql_ads_scan = null

azure_attribute_absence["sql_ads_scan"] {
    count([c | lower(input.resources[_].type) == "microsoft.sql/servers/vulnerabilityassessments"; c := 1]) == 0
}

azure_attribute_absence["sql_ads_scan"] {
    resource := input.resources[_]
    lower(resource.type) == "microsoft.sql/servers/vulnerabilityassessments"
    not resource.properties.recurringScans.isEnabled
}

azure_issue["sql_ads_scan"] {
    resource := input.resources[_]
    lower(resource.type) == "microsoft.sql/servers"
    count([c | r := input.resources[_];
              lower(r.type) == "microsoft.sql/servers/vulnerabilityassessments";
              array_contains(r.dependsOn, concat("/", [resource.type, resource.name]));
              r.properties.recurringScans.isEnabled;
              c := 1]) == 0
}

sql_ads_scan {
    lower(input.resources[_].type) == "microsoft.sql/servers"
    not azure_attribute_absence["sql_ads_scan"]
    not azure_issue["sql_ads_scan"]
}

sql_ads_scan = false {
    lower(input.resources[_].type) == "microsoft.sql/servers"
    azure_issue["sql_ads_scan"]
}

sql_ads_scan = false {
    lower(input.resources[_].type) == "microsoft.sql/servers"
    azure_attribute_absence["sql_ads_scan"]
}

sql_ads_scan_err = "Azure SQL Server advanced data security recurring scans currently is not enabled" {
    lower(input.resources[_].type) == "microsoft.sql/servers"
    azure_issue["sql_ads_scan"]
} else = "Azure SQL Server advanced data security attribute 'recurringScans.isEnabled' is missing from the resource" {
    lower(input.resources[_].type) == "microsoft.sql/servers"
    azure_attribute_absence["sql_ads_scan"]
}

sql_ads_scan_metadata := {
    "Policy Code": "PR-AZR-CLD-SQL-051",
    "Type": "Cloud",
    "Product": "AZR",
    "Language": "ARM template",
    "Policy Title": "Azure SQL Server advanced data security recurring scans should be enabled",
    "Policy Description": "Advanced data security (ADS) provides a set of advanced SQL security capabilities, including vulnerability assessment, threat detection, and data discovery and classification.<br><br>This policy identifies Azure SQL servers that do not have ADS enabled. As a best practice, enable ADS on mission-critical SQL servers.",
    "Resource Type": "microsoft.sql/servers/vulnerabilityassessments",
    "Policy Help URL": "",
    "Resource Help URL": "https://docs.microsoft.com/en-us/azure/templates/microsoft.sql/servers/vulnerabilityassessments?tabs=json"
}


# PR-AZR-CLD-SQL-052
# not supported in cloud

# default sql_logical_ads_scan = null

# azure_attribute_absence["sql_logical_ads_scan"] {
#     resource := input.resources[_]
#     lower(resource.type) == "microsoft.sql/servers"
#     sql_resource := resource.resources[_]
#     lower(sql_resource.type) == "vulnerabilityassessments"
#     not sql_resource.properties.recurringScans.isEnabled
# }

# azure_issue["sql_logical_ads_scan"] {
#     resource := input.resources[_]
#     lower(resource.type) == "microsoft.sql/servers"
#     sql_resource := resource.resources[_]
#     lower(sql_resource.type) == "vulnerabilityassessments"
#     sql_resource.properties.recurringScans.isEnabled != true
# }

# sql_logical_ads_scan {
#     resource := input.resources[_]
#     lower(resource.type) == "microsoft.sql/servers"
#     sql_resource := resource.resources[_]
#     lower(sql_resource.type) == "vulnerabilityassessments"
#     not azure_attribute_absence["sql_logical_ads_scan"]
#     not azure_issue["sql_logical_ads_scan"]
    
# }

# sql_logical_ads_scan = false {
#     azure_issue["sql_logical_ads_scan"]
# }

# sql_logical_ads_scan = false {
#     azure_attribute_absence["sql_logical_ads_scan"]
# }

# sql_logical_ads_scan_err = "Azure SQL Server advanced data security attribute 'recurringScans.isEnabled' is missing from the resource" {
#     azure_attribute_absence["sql_logical_ads_scan"]
# } else = "Azure SQL Server advanced data security recurring scans currently is not enabled" {
#     azure_issue["sql_logical_ads_scan"]
# }

# sql_logical_ads_scan_metadata := {
#     "Policy Code": "PR-AZR-CLD-SQL-052",
#     "Type": "Cloud",
#     "Product": "AZR",
#     "Language": "ARM template",
#     "Policy Title": "Azure SQL Server advanced data security recurring scans should be enabled",
#     "Policy Description": "Advanced data security (ADS) provides a set of advanced SQL security capabilities, including vulnerability assessment, threat detection, and data discovery and classification.<br><br>This policy identifies Azure SQL servers that do not have ADS enabled. As a best practice, enable ADS on mission-critical SQL servers.",
#     "Resource Type": "microsoft.sql/servers/vulnerabilityassessments",
#     "Policy Help URL": "",
#     "Resource Help URL": "https://docs.microsoft.com/en-us/azure/templates/microsoft.sql/servers/vulnerabilityassessments?tabs=json"
# }


#
# PR-AZR-CLD-SQL-053
#

default sql_ads_mail = null

azure_attribute_absence["sql_ads_mail"] {
    count([c | lower(input.resources[_].type) == "microsoft.sql/servers/vulnerabilityassessments"; c := 1]) == 0
}

azure_attribute_absence["sql_ads_mail"] {
    resource := input.resources[_]
    lower(resource.type) == "microsoft.sql/servers/vulnerabilityassessments"
    not resource.properties.recurringScans.emails
}

azure_issue["sql_ads_mail"] {
    resource := input.resources[_]
    lower(resource.type) == "microsoft.sql/servers"
    count([c | r := input.resources[_];
              lower(r.type) == "microsoft.sql/servers/vulnerabilityassessments";
              array_contains(r.dependsOn, concat("/", [resource.type, resource.name]));
              count(r.properties.recurringScans.emails) > 0;
              c := 1]) == 0
}

sql_ads_mail {
    lower(input.resources[_].type) == "microsoft.sql/servers"
    not azure_attribute_absence["sql_ads_mail"]
    not azure_issue["sql_ads_mail"]
}

sql_ads_mail = false {
    lower(input.resources[_].type) == "microsoft.sql/servers"
    azure_issue["sql_ads_mail"]
}

sql_ads_mail = false {
    lower(input.resources[_].type) == "microsoft.sql/servers"
    azure_attribute_absence["sql_ads_mail"]
}

sql_ads_mail_err = "Azure SQL Server advanced data security currently does not have any email alert recipient to get scan notification" {
    lower(input.resources[_].type) == "microsoft.sql/servers"
    azure_issue["sql_ads_mail"]
} else = "Azure SQL Server advanced data security attribute 'recurringScans.emails' is missing from the resource" {
    lower(input.resources[_].type) == "microsoft.sql/servers"
    azure_attribute_absence["sql_ads_mail"]
}

sql_ads_mail_metadata := {
    "Policy Code": "PR-AZR-CLD-SQL-053",
    "Type": "Cloud",
    "Product": "AZR",
    "Language": "ARM template",
    "Policy Title": "Azure SQL Server advanced data security should have email alert recipient to get scan notification",
    "Policy Description": "Advanced data security (ADS) provides a set of advanced SQL security capabilities, including vulnerability assessment, threat detection, and data discovery and classification.<br><br>This policy identifies Azure SQL Servers that do not have an email address configured for ADS alert notifications. As a best practice, provide one or more email addresses where you want to receive alerts for any anomalous activities detected on SQL Servers.",
    "Resource Type": "microsoft.sql/servers/vulnerabilityassessments",
    "Policy Help URL": "",
    "Resource Help URL": "https://docs.microsoft.com/en-us/azure/templates/microsoft.sql/servers/vulnerabilityassessments?tabs=json"
}


# PR-AZR-CLD-SQL-054
# not supported in cloud

# default sql_logical_ads_mail = null

# azure_attribute_absence["sql_logical_ads_mail"] {
#     resource := input.resources[_]
#     lower(resource.type) == "microsoft.sql/servers"
#     sql_resource := resource.resources[_]
#     lower(sql_resource.type) == "vulnerabilityassessments"
#     not sql_resource.properties.recurringScans.emails
# }

# azure_issue["sql_logical_ads_mail"] {
#     resource := input.resources[_]
#     lower(resource.type) == "microsoft.sql/servers"
#     sql_resource := resource.resources[_]
#     lower(sql_resource.type) == "vulnerabilityassessments"
#     count(sql_resource.properties.recurringScans.emails) == 0
# }

# sql_logical_ads_mail {
#     resource := input.resources[_]
#     lower(resource.type) == "microsoft.sql/servers"
#     sql_resource := resource.resources[_]
#     lower(sql_resource.type) == "vulnerabilityassessments"
#     not azure_attribute_absence["sql_logical_ads_mail"]
#     not azure_issue["sql_logical_ads_mail"]
# }

# sql_logical_ads_mail = false {
#     azure_issue["sql_logical_ads_mail"]
# }

# sql_logical_ads_mail = false {
#     azure_attribute_absence["sql_logical_ads_mail"]
# }

# sql_logical_ads_mail_err = "Azure SQL Server advanced data security attribute 'recurringScans.emails' is missing from the resource" {
#     azure_attribute_absence["sql_logical_ads_mail"]
# } else = "Azure SQL Server advanced data security currently does not have any email alert recipient to get scan notification" {
#     azure_issue["sql_logical_ads_mail"]
# }

# sql_logical_ads_mail_metadata := {
#     "Policy Code": "PR-AZR-CLD-SQL-054",
#     "Type": "Cloud",
#     "Product": "AZR",
#     "Language": "ARM template",
#     "Policy Title": "Azure SQL Server advanced data security should have email alert recipient to get scan notification",
#     "Policy Description": "Advanced data security (ADS) provides a set of advanced SQL security capabilities, including vulnerability assessment, threat detection, and data discovery and classification.<br><br>This policy identifies Azure SQL Servers that do not have an email address configured for ADS alert notifications. As a best practice, provide one or more email addresses where you want to receive alerts for any anomalous activities detected on SQL Servers.",
#     "Resource Type": "microsoft.sql/servers/vulnerabilityassessments",
#     "Policy Help URL": "",
#     "Resource Help URL": "https://docs.microsoft.com/en-us/azure/templates/microsoft.sql/servers/vulnerabilityassessments?tabs=json"
# }




#
# PR-AZR-CLD-SQL-055
#

default sql_ads_alert = null

azure_attribute_absence["sql_ads_alert"] {
    count([c | lower(input.resources[_].type) == "microsoft.sql/servers/vulnerabilityassessments"; c := 1]) == 0
}

azure_attribute_absence["sql_ads_alert"] {
    resource := input.resources[_]
    lower(resource.type) == "microsoft.sql/servers/vulnerabilityassessments"
    not resource.properties.recurringScans.emailSubscriptionAdmins
}

azure_issue["sql_ads_alert"] {
    resource := input.resources[_]
    lower(resource.type) == "microsoft.sql/servers"
    count([c | r := input.resources[_];
              lower(r.type) == "microsoft.sql/servers/vulnerabilityassessments";
              array_contains(r.dependsOn, concat("/", [resource.type, resource.name]));
              r.properties.recurringScans.emailSubscriptionAdmins;
              c := 1]) == 0
}

sql_ads_alert {
    lower(input.resources[_].type) == "microsoft.sql/servers"
    not azure_attribute_absence["sql_ads_alert"]
    not azure_issue["sql_ads_alert"]
}

sql_ads_alert = false {
    lower(input.resources[_].type) == "microsoft.sql/servers"
    azure_issue["sql_ads_alert"]
}

sql_ads_alert = false {
    lower(input.resources[_].type) == "microsoft.sql/servers"
    azure_attribute_absence["sql_ads_alert"]
}

sql_ads_alert_err = "Sending Alert to the to subscription administrators is currently not enabled in Azure SQL Server advanced data security" {
    lower(input.resources[_].type) == "microsoft.sql/servers"
    azure_issue["sql_ads_alert"]
} else = "Azure SQL Server advanced data security attribute 'recurringScans.emailSubscriptionAdmins' is missing from the resource" {
    lower(input.resources[_].type) == "microsoft.sql/servers"
    azure_attribute_absence["sql_ads_alert"]
}

sql_ads_alert_metadata := {
    "Policy Code": "PR-AZR-CLD-SQL-055",
    "Type": "Cloud",
    "Product": "AZR",
    "Language": "ARM template",
    "Policy Title": "Azure SQL Server advanced data security should send alerts to subscription administrators",
    "Policy Description": "Advanced data security (ADS) provides a set of advanced SQL security capabilities, including vulnerability assessment, threat detection, and data discovery and classification.<br><br>This policy identifies Azure SQL Servers that are not enabled with ADS. As a best practice, enable ADS so that the administratorsâ€”service and co-administratorâ€”can receive email alerts when anomalous activities are detected on the SQL Servers.",
    "Resource Type": "microsoft.sql/servers/vulnerabilityassessments",
    "Policy Help URL": "",
    "Resource Help URL": "https://docs.microsoft.com/en-us/azure/templates/microsoft.sql/servers/vulnerabilityassessments?tabs=json"
}



# PR-AZR-CLD-SQL-059
# not supported in cloud

# default sql_logical_ads_alert = null

# azure_attribute_absence["sql_logical_ads_alert"] {
#     resource := input.resources[_]
#     lower(resource.type) == "microsoft.sql/servers"
#     sql_resource := resource.resources[_]
#     lower(sql_resource.type) == "vulnerabilityassessments"
#     not sql_resource.properties.recurringScans.emailSubscriptionAdmins
# }

# azure_issue["sql_logical_ads_alert"] {
#     resource := input.resources[_]
#     lower(resource.type) == "microsoft.sql/servers"
#     sql_resource := resource.resources[_]
#     lower(sql_resource.type) == "vulnerabilityassessments"
#     sql_resource.properties.recurringScans.emailSubscriptionAdmins != true
# }

# sql_logical_ads_alert {
#     resource := input.resources[_]
#     lower(resource.type) == "microsoft.sql/servers"
#     sql_resource := resource.resources[_]
#     lower(sql_resource.type) == "vulnerabilityassessments"
#     not azure_attribute_absence["sql_logical_ads_alert"]
#     not azure_issue["sql_logical_ads_alert"]
# }

# sql_logical_ads_alert = false {
#     azure_issue["sql_logical_ads_alert"]
# }

# sql_logical_ads_alert = false {
#     azure_attribute_absence["sql_logical_ads_alert"]
# }

# sql_logical_ads_alert_err = "Azure SQL Server advanced data security attribute 'recurringScans.emailSubscriptionAdmins' is missing from the resource" {
#     azure_attribute_absence["sql_logical_ads_alert"]
# } else = "Sending Alert to the to subscription administrators is currently not enabled in Azure SQL Server advanced data security" {
#     azure_issue["sql_logical_ads_alert"]
# }

# sql_logical_ads_alert_metadata := {
#     "Policy Code": "PR-AZR-CLD-SQL-059",
#     "Type": "Cloud",
#     "Product": "AZR",
#     "Language": "ARM template",
#     "Policy Title": "Azure SQL Server advanced data security should send alerts to subscription administrators",
#     "Policy Description": "Advanced data security (ADS) provides a set of advanced SQL security capabilities, including vulnerability assessment, threat detection, and data discovery and classification.<br><br>This policy identifies Azure SQL Servers that are not enabled with ADS. As a best practice, enable ADS so that the administratorsâ€”service and co-administratorâ€”can receive email alerts when anomalous activities are detected on the SQL Servers.",
#     "Resource Type": "microsoft.sql/servers/vulnerabilityassessments",
#     "Policy Help URL": "",
#     "Resource Help URL": "https://docs.microsoft.com/en-us/azure/templates/microsoft.sql/servers/vulnerabilityassessments?tabs=json"
# }


#
# PR-AZR-CLD-SQL-062
#

default sql_ads_va_configured = null

azure_attribute_absence["sql_ads_scan_configured"] {
    count([c | lower(input.resources[_].type) == "microsoft.sql/servers/vulnerabilityassessments"; c := 1]) == 0
}

azure_attribute_absence["sql_ads_va_configured"] {
    resource := input.resources[_]
    lower(resource.type) == "microsoft.sql/servers/vulnerabilityassessments"
    not resource.properties.storageContainerPath
}

azure_issue["sql_ads_va_configured"] {
    resource := input.resources[_]
    lower(resource.type) == "microsoft.sql/servers"
    count([c | r := input.resources[_];
              lower(r.type) == "microsoft.sql/servers/vulnerabilityassessments";
              array_contains(r.dependsOn, concat("/", [resource.type, resource.name]));
              count(r.properties.storageContainerPath) > 0;
              c := 1]) == 0
}

sql_ads_va_configured {
    lower(input.resources[_].type) == "microsoft.sql/servers"
    not azure_attribute_absence["sql_ads_va_configured"]
    not azure_issue["sql_ads_va_configured"]
}

sql_ads_va_configured = false {
    lower(input.resources[_].type) == "microsoft.sql/servers"
    azure_issue["sql_ads_va_configured"]
}

sql_ads_va_configured = false {
    lower(input.resources[_].type) == "microsoft.sql/servers"
    azure_attribute_absence["sql_ads_va_configured"]
}

sql_ads_va_configured_err = "Azure SQL Server advanced data security currently is not enabled" {
    lower(input.resources[_].type) == "microsoft.sql/servers"
    azure_issue["sql_ads_va_configured"]
} else = "Azure SQL Server advanced data security attribute 'storageContainerPath' is missing from the resource" {
    lower(input.resources[_].type) == "microsoft.sql/servers"
    azure_attribute_absence["sql_ads_va_configured"]
}

sql_ads_va_configured_metadata := {
    "Policy Code": "PR-AZR-CLD-SQL-062",
    "Type": "Cloud",
    "Product": "AZR",
    "Language": "ARM template",
    "Policy Title": "Azure SQL Server advanced data security should be enabled",
    "Policy Description": "Advanced data security (ADS) provides a set of advanced SQL security capabilities, including vulnerability assessment, threat detection, and data discovery and classification.<br><br>This policy identifies Azure SQL servers that do not have ADS enabled. As a best practice, enable ADS on mission-critical SQL servers.",
    "Resource Type": "microsoft.sql/servers/vulnerabilityassessments",
    "Policy Help URL": "",
    "Resource Help URL": "https://docs.microsoft.com/en-us/azure/templates/microsoft.sql/servers/vulnerabilityassessments?tabs=json"
}


# PR-AZR-CLD-SQL-063
# not supported in cloud

# default sql_logical_ads_va_configured = null

# azure_attribute_absence["sql_logical_ads_va_configured"] {
#     resource := input.resources[_]
#     lower(resource.type) == "microsoft.sql/servers"
#     sql_resource := resource.resources[_]
#     lower(sql_resource.type) == "vulnerabilityassessments"
#     not sql_resource.properties.storageContainerPath
# }

# azure_issue["sql_logical_ads_va_configured"] {
#     resource := input.resources[_]
#     lower(resource.type) == "microsoft.sql/servers"
#     sql_resource := resource.resources[_]
#     lower(sql_resource.type) == "vulnerabilityassessments"
#     count(sql_resource.properties.storageContainerPath) == 0
# }

# sql_logical_ads_va_configured {
#     resource := input.resources[_]
#     lower(resource.type) == "microsoft.sql/servers"
#     sql_resource := resource.resources[_]
#     lower(sql_resource.type) == "vulnerabilityassessments"
#     not azure_attribute_absence["sql_logical_ads_va_configured"]
#     not azure_issue["sql_logical_ads_va_configured"]
    
# }

# sql_logical_ads_va_configured = false {
#     azure_issue["sql_logical_ads_va_configured"]
# }

# sql_logical_ads_va_configured = false {
#     azure_attribute_absence["sql_logical_ads_va_configured"]
# }

# sql_logical_ads_va_configured_err = "Azure SQL Server advanced data security attribute 'storageContainerPath' is missing from the resource" {
#     azure_attribute_absence["sql_logical_ads_va_configured"]
# } else = "Azure SQL Server advanced data security currently is not enabled" {
#     azure_issue["sql_logical_ads_va_configured"]
# }

# sql_logical_ads_va_configured_metadata := {
#     "Policy Code": "PR-AZR-CLD-SQL-063",
#     "Type": "Cloud",
#     "Product": "AZR",
#     "Language": "ARM template",
#     "Policy Title": "Azure SQL Server advanced data security should be enabled",
#     "Policy Description": "Advanced data security (ADS) provides a set of advanced SQL security capabilities, including vulnerability assessment, threat detection, and data discovery and classification.<br><br>This policy identifies Azure SQL servers that do not have ADS enabled. As a best practice, enable ADS on mission-critical SQL servers.",
#     "Resource Type": "microsoft.sql/servers/vulnerabilityassessments",
#     "Policy Help URL": "",
#     "Resource Help URL": "https://docs.microsoft.com/en-us/azure/templates/microsoft.sql/servers/vulnerabilityassessments?tabs=json"
# }