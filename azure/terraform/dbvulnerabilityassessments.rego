package rule

# https://docs.microsoft.com/en-us/azure/templates/microsoft.sql/2017-03-01-preview/servers/databases/vulnerabilityassessments

#
# PR-AZR-0056-TRF
#

default db_ads_mail = null

azure_attribute_absence["db_ads_mail"] {
    resource := input.resources[_]
    lower(resource.type) == "azurerm_mssql_server_vulnerability_assessment"
    not resource.properties.recurring_scans
}

azure_issue["db_ads_mail"] {
    resource := input.resources[_]
    lower(resource.type) == "azurerm_mssql_server_vulnerability_assessment"
    resource.properties.recurring_scans.enabled != true
}

azure_issue["db_ads_mail"] {
    resource := input.resources[_]
    lower(resource.type) == "azurerm_mssql_server_vulnerability_assessment"
    resource.properties.recurring_scans.email_subscription_admins != true
}

azure_issue["db_ads_mail"] {
    resource := input.resources[_]
    lower(resource.type) == "azurerm_mssql_server_vulnerability_assessment"
    count(resource.properties.recurring_scans.emails) == 0
}

db_ads_mail {
    lower(input.resources[_].type) == "azurerm_mssql_server_vulnerability_assessment"
    not azure_issue["db_ads_mail"]
    not azure_attribute_absence["db_ads_mail"]
}

db_ads_mail = false {
    azure_issue["db_ads_mail"]
}

db_ads_mail = false {
    azure_attribute_absence["db_ads_mail"]
}

db_ads_mail_err = "Azure SQL Server advanced data security does not have an email alert recipient" {
    azure_issue["db_ads_mail"]
}

db_ads_mail_miss_err = "Database VA attribute recurring_scans missing in the resource" {
    azure_attribute_absence["db_ads_mail"]
}

db_ads_mail_metadata := {
    "Policy Code": "PR-AZR-0056-TRF",
    "Type": "IaC",
    "Product": "AZR",
    "Language": "Terraform",
    "Policy Title": "Azure SQL Server advanced data security does not have an email alert recipient",
    "Policy Description": "Advanced data security (ADS) provides a set of advanced SQL security capabilities, including vulnerability assessment, threat detection, and data discovery and classification._x005F_x000D_ _x005F_x000D_ This policy identifies Azure SQL Servers that do not have an email address configured for ADS alert notifications. As a best practice, provide one or more email addresses where you want to receive alerts for any anomalous activities detected on SQL Servers.",
    "Compliance": [],
    "Resource Type": "azurerm_mssql_server_vulnerability_assessment",
    "Policy Help URL": "",
    "Resource Help URL": "https://docs.microsoft.com/en-us/azure/templates/microsoft.sql/2017-03-01-preview/servers/databases/vulnerabilityassessments"
}

#
# PR-AZR-0057-TRF
#

default db_ads_alert = null

azure_attribute_absence["db_ads_alert"] {
    resource := input.resources[_]
    lower(resource.type) == "azurerm_mssql_server_vulnerability_assessment"
    not resource.properties.recurring_scans
}

azure_issue["db_ads_alert"] {
    resource := input.resources[_]
    lower(resource.type) == "azurerm_mssql_server_vulnerability_assessment"
    resource.properties.recurring_scans.enabled != true
}

azure_issue["db_ads_alert"] {
    resource := input.resources[_]
    lower(resource.type) == "azurerm_mssql_server_vulnerability_assessment"
    resource.properties.recurring_scans.email_subscription_admins != true
}

db_ads_alert {
    lower(input.resources[_].type) == "azurerm_mssql_server_vulnerability_assessment"
    not azure_issue["db_ads_alert"]
    not azure_attribute_absence["db_ads_alert"]
}

db_ads_alert = false {
    azure_issue["db_ads_alert"]
}

db_ads_alert = false {
    azure_attribute_absence["db_ads_alert"]
}

db_ads_alert_err = "Azure SQL Server advanced data security does not send alerts to service and co-administrators" {
    azure_issue["db_ads_alert"]
}

db_ads_alert_miss_err = "Database VA attribute recurring_scans missing in the resource" {
    azure_attribute_absence["db_ads_alert"]
}

db_ads_alert_metadata := {
    "Policy Code": "PR-AZR-0057-TRF",
    "Type": "IaC",
    "Product": "AZR",
    "Language": "Terraform",
    "Policy Title": "Azure SQL Server advanced data security does not send alerts to service and co-administrators",
    "Policy Description": "Advanced data security (ADS) provides a set of advanced SQL security capabilities, including vulnerability assessment, threat detection, and data discovery and classification._x005F_x000D_ _x005F_x000D_ This policy identifies Azure SQL Servers that are not enabled with ADS. As a best practice, enable ADS so that the administratorsâ€”service and co-administratorâ€”can receive email alerts when anomalous activities are detected on the SQL Servers.",
    "Compliance": [],
    "Resource Type": "azurerm_mssql_server_vulnerability_assessment",
    "Policy Help URL": "",
    "Resource Help URL": "https://docs.microsoft.com/en-us/azure/templates/microsoft.sql/2017-03-01-preview/servers/databases/vulnerabilityassessments"
}

#
# PR-AZR-0058-TRF
#

default db_ads_scan = null

azure_attribute_absence["db_ads_scan"] {
    resource := input.resources[_]
    lower(resource.type) == "azurerm_mssql_server_vulnerability_assessment"
    not resource.properties.recurring_scans.enabled
}

azure_issue["db_ads_scan"] {
    resource := input.resources[_]
    lower(resource.type) == "azurerm_mssql_server_vulnerability_assessment"
    resource.properties.recurring_scans.enabled != true
}

db_ads_scan {
    lower(input.resources[_].type) == "azurerm_mssql_server_vulnerability_assessment"
    not azure_issue["db_ads_scan"]
    not azure_attribute_absence["db_ads_scan"]
}

db_ads_scan = false {
    azure_issue["db_ads_scan"]
}

db_ads_scan = false {
    azure_attribute_absence["db_ads_scan"]
}

db_ads_scan_err = "Azure SQL Server advanced data security is disabled" {
    azure_issue["db_ads_scan"]
}

db_ads_scan_miss_err = "Database VA attribute recurring_scans missing in the resource" {
    azure_attribute_absence["db_ads_scan"]
}

db_ads_scan_metadata := {
    "Policy Code": "PR-AZR-0058-TRF",
    "Type": "IaC",
    "Product": "AZR",
    "Language": "Terraform",
    "Policy Title": "Azure SQL Server advanced data security is disabled",
    "Policy Description": "Advanced data security (ADS) provides a set of advanced SQL security capabilities, including vulnerability assessment, threat detection, and data discovery and classification._x005F_x000D_ _x005F_x000D_ This policy identifies Azure SQL servers that do not have ADS enabled. As a best practice, enable ADS on mission-critical SQL servers.",
    "Compliance": [],
    "Resource Type": "azurerm_mssql_server_vulnerability_assessment",
    "Policy Help URL": "",
    "Resource Help URL": "https://docs.microsoft.com/en-us/azure/templates/microsoft.sql/2017-03-01-preview/servers/databases/vulnerabilityassessments"
}
